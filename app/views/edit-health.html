{% extends "layout.html" %}

{% block pageTitle %}
Edit project health
{% endblock %}

{% block content %}

<main id="content" role="main">

    <div class="grid-row">
        <section style="padding-top:30px;">

            <h1 class="form-title heading-large">
                Edit project health
            </h1>

            <div class="grid-row">
                <section class="column-half">
                    <h2 class="heading-medium">Edit health status for <a href="/projects/{{ project.id }}/{{ project.name | slugify }}">{{ project.name }}</a></h2>
                    <form class="form" id="healthStatusForm">

                        <!-- type -->
                        <div class="form-group">
                            <label class="form-label-bold" for="type">
                                Healthcheck Type
                            </label>

                            <select class="form-control" name="health[type]" id="type">
                                <option value="overall">Overall</option>
                                <option value="engineering">Engineering</option>
                                <option value="ops">Ops</option>
                                <option value="userResearch">User Research</option>
                                <option value="security">Security</option>
                                <option value="delivery">Delivery</option>
                                <option value="data">Data</option>
                            </select>
                        </div>

                        <!-- status -->
                        <div class="form-group">
                            <label class="form-label-bold" for="status">
                                Healthcheck Status
                                <span class="form-hint">
                                    Health of the project
                                </span>
                            </label>

                            <select class="form-control" name="health[status]" id="status">
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="risk">Risk</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>

                        <!-- comment -->
                        <div class="form-group">
                            <label class="form-label-bold" for="comment">
                                Comment
                                <span class="form-hint">
                                    Reason for the health status change
                                </span>
                            </label>
                            <textarea class="form-control" id="comment" name="health[comment]" maxlength="500">{{ project.health.comment }}</textarea>
                        </div>

                        <!-- link title-->
                        <div class="form-group">
                            <label class="form-label-bold" for="name">
                                Healthcheck Link
                                <span class="form-hint">
                                    Title of the link
                                </span>
                            </label>
                            <input type="text" name="health[link][name]" id="name" placeholder="Example Title"></input>
                                <span class="form-hint">
                                    Web address of the link
                                </span>
                            <input type="url" name="health[link][url]" placeholder="http://example.com/"></input>
                        </div>

                        <div class="form-group">
                            <input type="submit" class="button" value="Submit">
                        </div>
                    </form>

                    {% if project["healthHistory"] %}
                    <div class="grid-row">
                        <h2 class="heading-medium">Health history <span data-collapsable-parent="health-history" class="clickable">[+]</span></h2>
                        <div data-collapsable-child="health-history" style="display: none;">
                            {% for health in project.healthHistory %}
                            <div>
                                <p>{{ health.status }} &mdash; {{ convertDate(health.date) }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                </section>

            </div>
        </section>
    </div>
</main>
{% endblock %}

{% block body_end %}
{{ super() }}
<script src="/public/javascripts/jquery.plugin.min.js"></script>
<script src="/public/javascripts/jquery.maxlength.min.js"></script>
<script>
    $("#healthStatusForm").submit(function(e) {
        e.preventDefault();
        var formData = JSON.stringify($('#healthStatusForm').serializeObject());
        console.log(formData)
        $.ajax({
            type: "PUT",
            url: '/api/projects/{{ project.id }}/health',
            contentType: "application/json",
            data: formData
        })
        .done(function(response) {
            alert(JSON.stringify(response.messages[0]));
            window.location.href = '/projects/{{ project.id }}/{{ project.name | slugify }}';
        })
        .fail(function(jqXHR) {
            alert('There was an error updating health status. Details: \n\n' + jqXHR.responseText);
        });
    });

    $("select#type").val("overall");
    $("select#status").val("{{ project.health.overall.status }}");

    $('#comment').maxlength({max: 500});
</script>
{% endblock %}
